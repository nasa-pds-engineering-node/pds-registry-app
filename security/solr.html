<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from src/site/xdoc/security/solr.xml.vm at 2021-04-18
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>Registry Application &#x2013; Elasticsearch Security</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.8.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="https://pds.nasa.gov" id="bannerLeft"><img src="../images/pds_banner.png"  alt="" width="500"/></a></div>
          <div class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" id="bannerRight"><h2>PDS Registry</h2>
</a></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-04-18<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.3.0-SNAPSHOT</li>
      <li class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" class="externalLink" title="Registry App Github Repo">Registry App Github Repo</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Software Documentation</li>
    <li><a href="../index.html" title="About PDS Registry Application"><span class="none"></span>About PDS Registry Application</a></li>
    <li><a href="../install/index.html" title="Installation"><span class="icon-chevron-down"></span>Installation</a>
     <ul class="nav nav-list">
      <li><a href="../install/java.html" title="Java"><span class="none"></span>Java</a></li>
      <li><a href="../install/es-dev.html" title="Elasticsearch - Quick Start"><span class="none"></span>Elasticsearch - Quick Start</a></li>
      <li><a href="../install/tools.html" title="Tools (Manager, Harvest)"><span class="none"></span>Tools (Manager, Harvest)</a></li>
      <li><a href="../install/api-server.html" title="API Server"><span class="none"></span>API Server</a></li>
      <li><a href="../install/test.html" title="Test your deployment"><span class="none"></span>Test your deployment</a></li>
     </ul></li>
    <li><a href="../operate/index.html" title="Operation"><span class="icon-chevron-down"></span>Operation</a>
     <ul class="nav nav-list">
      <li><a href="../operate/common-ops.html" title="Common Operations"><span class="none"></span>Common Operations</a></li>
      <li><a href="../operate/test-vs-prod.html" title="Test vs Prod"><span class="none"></span>Test vs Prod</a></li>
      <li><a href="../operate/harvest.html" title="Harvest"><span class="none"></span>Harvest</a></li>
      <li><a href="../operate/reg-manager.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
      <li><a href="../operate/reg-custom.html" title="Registry Customization"><span class="none"></span>Registry Customization</a></li>
     </ul></li>
    <li><a href="../prod/index.html" title="Production Deployment"><span class="icon-chevron-down"></span>Production Deployment</a>
     <ul class="nav nav-list">
      <li><a href="../prod/es-vm.html" title="Elasticsearch (VM)"><span class="none"></span>Elasticsearch (VM)</a></li>
     </ul></li>
    <li><a href="../security/index.html" title="Security"><span class="icon-chevron-down"></span>Security</a>
     <ul class="nav nav-list">
      <li><a href="../security/proxy.html" title="Load Balancer & Proxy"><span class="none"></span>Load Balancer & Proxy</a></li>
      <li><a href="../security/es.html" title="Elasticsearch"><span class="none"></span>Elasticsearch</a></li>
      <li><a href="../security/reg-mgr.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
     </ul></li>
    <li><a href="../index.html#Support" title="Support"><span class="none"></span>Support</a></li>
   <li class="nav-header">Downloads</li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/v0.3.0-SNAPSHOT/pds-registry-app-0.3.0-SNAPSHOT-bin.tar.gz" class="externalLink" title="Current Release (tar.gz)"><span class="none"></span>Current Release (tar.gz)</a></li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/v0.3.0-SNAPSHOT/pds-registry-app-0.3.0-SNAPSHOT-bin.zip" class="externalLink" title="Current Release (zip)"><span class="none"></span>Current Release (zip)</a></li>
    <li><a href="https://pds-engineering.jpl.nasa.gov/content/pds4-software" class="externalLink" title="Past Releases"><span class="none"></span>Past Releases</a></li>
   <li class="nav-header">Change Log</li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/blob/master/CHANGELOG.md" class="externalLink" title="on github"><span class="none"></span>on github</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >



<section>
<h2><a name="Elasticsearch_Security"></a>Elasticsearch Security</h2>


<p>
</p>
<ul>
  
<li><a href="#mTLS">Mutual TLS Authentication</a></li>
  
<ul>
    
<li><a href="#Keys_and_Certificates">Keys and Certificates</a></li>
    
<li><a href="#Configure_Solr">Configure Solr</a></li>
    
<li><a href="#Configure_Registry_Manager">Configure Registry Manager</a></li>
  </ul>
</ul>



<section>
<h3><a name="Overview"></a>Overview</h3>


<div class="source"><pre class="prettyprint">
drwxr-sr-x. 2 root elasticsearch    43 Sep  3 20:50 ssl
</pre></div>


<div class="source"><pre class="prettyprint">
openssl req -x509 -newkey rsa:4096 -keyout es-key.pem -out es-cert.pem -days 365 -subj '/CN=*.test.local' -nodes
</pre></div>




<div class="source"><pre class="prettyprint">
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
</pre></div>


</section>

<a name="mTLS"></a><section id="mTLS">
<h3><a name="Mutual_TLS_Authentication"></a>Mutual TLS Authentication</h3>


<p style="color:red;">
<b>NOTE:</b> TLS / SSL functionality in Solr 8.5.x is not working 
(See <a class="externalLink" href="https://issues.apache.org/jira/browse/SOLR-14105" target="_blank" style="color:red;">SOLR-14105 issue</a> for more info).
You have to use Solr 8.4.x. 
</p>


<p>
Mutual TLS is based on asymmetric (public-key) cryptography. 
Both the server and clients identify itself by a Distinguished Name (DN) contained in their certificates.
</p>


<p>
<img src="../images/m-tls-solr.png" style="width:60em;" alt="" />
</p>



<section>
<h4><a name="Keys_and_Certificates"></a>Keys and Certificates</h4>


<p>
<b>Step 1: Generate server keys and certificates</b>
</p>


<p>
Run Java keytool to generate private and public key (keypair) for Solr nodes. 
In this example we will use the same keypair for all Solr nodes and wildcard Common Name (CN). 
You can also generate individual keypairs for each node.
</p>


<div class="source"><pre class="prettyprint">
keytool -genkeypair -alias &quot;solr&quot; -keystore &quot;solr.jks&quot; -dname &quot;CN=*.test.local&quot; -keyalg RSA -storepass &quot;password&quot;
</pre></div>


<p>
Export certificate.
</p>


<div class="source"><pre class="prettyprint">
keytool -exportcert -alias &quot;solr&quot; -keystore &quot;solr.jks&quot; -file &quot;solr.cer&quot; -storepass &quot;password&quot;
</pre></div>


<p>
<b>Step 2: Generate client keys and certificate</b>
</p>


<p>
Run Java keytool to generate keypair and export certificate. Use &quot;CN=solr-admin&quot;.
</p>


<div class="source"><pre class="prettyprint">
keytool -genkeypair -alias &quot;solr-admin&quot; -keystore &quot;solr-admin.jks&quot; -dname &quot;CN=solr-admin&quot; -keyalg RSA -storepass &quot;password&quot;
keytool -exportcert -alias &quot;solr-admin&quot; -keystore &quot;solr-admin.jks&quot; -file &quot;solr-admin.cer&quot; -storepass &quot;password&quot;
</pre></div>


<p>
<b>Step 3: Create server trust store</b>
</p>


<p>
Create server trust store and import Solr server and client certificates.
</p>


<div class="source"><pre class="prettyprint">
keytool -importcert -alias &quot;solr&quot; -keystore &quot;solr-trust.jks&quot; -file &quot;solr.cer&quot; -storepass &quot;password&quot;
keytool -importcert -alias &quot;solr-admin&quot; -keystore &quot;solr-trust.jks&quot; -file &quot;solr-admin.cer&quot; -storepass &quot;password&quot;
</pre></div>


<p>
<b>Step 4: Create client trust store</b>
</p>


<p>
Create client trust store and import Solr server and client certificates.
The same trust store can be used by all Solr clients. 
Although content of both server and client trust stores is the same at this point, 
you should use different files for servers and clients.
</p>


<div class="source"><pre class="prettyprint">
keytool -importcert -alias &quot;solr&quot; -keystore &quot;solr-admin-trust.jks&quot; -file &quot;solr.cer&quot; -storepass &quot;password&quot;
keytool -importcert -alias &quot;solr-admin&quot; -keystore &quot;solr-admin-trust.jks&quot; -file &quot;solr-admin.cer&quot; -storepass &quot;password&quot;
</pre></div>



</section><section>
<h4><a name="Configure_Solr"></a>Configure Solr</h4>


<p>
<b>Step 1: Set &quot;urlScheme&quot; cluster property</b>
</p>


<p>
Connect to ZooKeeper
</p>


<div class="source"><pre class="prettyprint">
/opt/zookeeper/bin/zkCli.sh -server zk1.test.local
</pre></div>


<p>
and create the following znode 
</p>


<div class="source"><pre class="prettyprint">
create /solr/clusterprops.json {&quot;urlScheme&quot;:&quot;https&quot;}
</pre></div>


<p>
You can also call Solr API to set the &quot;urlScheme&quot; cluster property
</p>


<div class="source"><pre class="prettyprint">
http://localhost:8983/solr/admin/collections?action=CLUSTERPROP&amp;name=urlScheme&amp;val=https
</pre></div>


<p>
<b>Step 2: Copy key and trust store</b>
</p>


<p>
In this example we will use <i>/opt/solr/ssl</i> directory. 
You can select another, more secure location.
</p>


<p>
Copy <i>solr.jks</i> and <i>solr-trust.jks</i> to all Solr nodes.
</p>


<p>
<b>Step 3: Edit Solr startup script</b>
</p>


<p>
Add following SSL parameters in <i>/opt/solr/bin/solr.in.sh</i> on each Solr node.
</p>


<div class="source"><pre class="prettyprint">
SOLR_SSL_KEY_STORE=/opt/solr/ssl/solr.jks
SOLR_SSL_KEY_STORE_PASSWORD=password
SOLR_SSL_TRUST_STORE=/opt/solr/ssl/solr-trust.jks
SOLR_SSL_TRUST_STORE_PASSWORD=password
SOLR_SSL_NEED_CLIENT_AUTH=true
</pre></div>


<p>
Also set SOLR_HOST variable in <i>/opt/solr/bin/solr.in.sh</i>. 
Default value, &quot;loacalhost&quot;, may cause SSL host validation issues.
</p>


<div class="source"><pre class="prettyprint">
SOLR_HOST=solr1.test.local
</pre></div>



<p>
<b>Step 4: Restart Solr on each node</b>
</p>


<div class="source"><pre class="prettyprint">
systemctl stop solr
systemctl start solr
</pre></div>




</section><section>
<h4><a name="Configure_Registry_Manager"></a>Configure Registry Manager</h4>


<p>
<b>Step 1: Copy key and trust store</b>
</p>


<p>
Copy <i>zk-client-solr.jks</i> and <i>zk-client-trust.jks</i> to your home directory or another location.
</p>


<p>
<b>Step 2: Edit Registry Manager startup script</b>
</p>


<p>
Add <i>SOLR_CLIENT_TLS_FLAGS</i> variable in <i>$REGISTRY_HOME/bin/registry-manager</i>.
Adjust key and trust store paths and passwords.
</p>


<div class="source"><pre class="prettyprint">
SOLR_CLIENT_TLS_FLAGS=&quot;
-Djavax.net.ssl.keyStore=/opt/solr/ssl/solr-admin.jks
-Djavax.net.ssl.keyStorePassword=password
-Djavax.net.ssl.trustStore=/opt/solr/ssl/solr-admin-trust.jks
-Djavax.net.ssl.trustStorePassword=password&quot;
</pre></div>


<p>
Replace last line in <i>$REGISTRY_HOME/bin/registry-manager</i>.
</p>


<div class="source"><pre class="prettyprint">
&quot;$JAVA&quot; $ZK_CLIENT_TLS_FLAGS -jar &quot;$TOOL_JAR&quot; $@
</pre></div>


<p>
with
</p>


<div class="source"><pre class="prettyprint">
&quot;$JAVA&quot; $ZK_CLIENT_TLS_FLAGS $SOLR_CLIENT_TLS_FLAGS -jar &quot;$TOOL_JAR&quot; $@
</pre></div>

</section></section>

</section>



        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      2021..</p>
        </div>
      </div>
    </footer>
  </body>
</html>
